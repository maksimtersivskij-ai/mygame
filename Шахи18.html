<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Neon Elite</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --neon: #00f2ff; --red: #ff4757; --cell: 45px; --gold: #ffd700; }
        body { margin: 0; background: #0a0a0c; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #menu, #guide { position: absolute; inset: 0; background: #0a0a0c; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #guide { display: none; overflow-y: auto; align-items: flex-start; text-align: left; }
        .panel { background: #1c1c21; padding: 25px; border-radius: 20px; border: 2px solid #333; width: 300px; text-align: center; }
        
        .btn { background: var(--neon); border: none; color: #000; padding: 14px; margin: 8px 0; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-secondary { background: #333; color: white; }
        input { background: #000; border: 1px solid #444; padding: 12px; width: calc(100% - 26px); border-radius: 10px; color: white; text-align: center; margin-bottom: 10px; }

        #game { display: none; flex-direction: column; align-items: center; }
        #status { margin-bottom: 15px; font-weight: bold; font-size: 18px; color: var(--neon); text-align: center; }
        
        #board { display: grid; grid-template-columns: repeat(8, var(--cell)); grid-template-rows: repeat(8, var(--cell)); border: 5px solid #333; }
        .cell { width: var(--cell); height: var(--cell); display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; position: relative; }
        .white-cell { background: #333; }
        .black-cell { background: #1a1a1a; }
        
        .cell.selected { background: rgba(0, 242, 255, 0.4) !important; }
        .cell.target::after { content: ''; width: 12px; height: 12px; background: var(--neon); border-radius: 50%; position: absolute; }
        .cell.capture::after { content: ''; width: 35px; height: 35px; border: 2px solid var(--red); border-radius: 50%; position: absolute; opacity: 0.5; }
        .cell.check { background: radial-gradient(circle, var(--red) 0%, transparent 70%) !important; }

        .piece { z-index: 2; user-select: none; }
        .w { color: white; text-shadow: 0 0 8px #fff; }
        .b { color: var(--red); text-shadow: 0 0 8px var(--red); }
        
        .flipped { transform: rotate(180deg); }
        .flipped .piece { transform: rotate(180deg); }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è */
        .guide-box { background: #1c1c21; padding: 20px; border-radius: 15px; width: 100%; max-width: 500px; border: 1px solid #333; }
        h3 { color: var(--neon); margin-top: 20px; border-bottom: 1px solid #333; }
        ul { padding-left: 20px; font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>

<div id="menu">
    <div class="panel">
        <h1 style="color:var(--neon)">NEON CHESS</h1>
        <button class="btn" onclick="start('bot')">–ü–†–û–¢–ò –ë–û–¢–ê</button>
        <button class="btn" onclick="start('local')">–í–î–í–û–• (–û–§–õ–ê–ô–ù)</button>
        <button class="btn btn-secondary" onclick="toggleGuide(true)">üìñ –ù–ê–í–ß–ê–ù–ù–Ø</button>
        <hr style="opacity:0.1; margin: 15px 0">
        <button class="btn" style="background:#1e90ff; color:white" onclick="start('create')">–°–¢–í–û–†–ò–¢–ò –ö–Ü–ú–ù–ê–¢–£</button>
        <input type="number" id="roomCode" placeholder="–ö–û–î">
        <button class="btn" style="background:#5352ed; color:white" onclick="start('join')">–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø</button>
    </div>
</div>

<div id="guide">
    <div class="guide-box">
        <button class="btn" onclick="toggleGuide(false)">üîô –ù–ê–ó–ê–î –î–û –ú–ï–ù–Æ</button>
        <h2>–ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏</h2>
        
        <h3>1. –ú–µ—Ç–∞ –≥—Ä–∏</h3>
        <p>–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ <b>–ú–∞—Ç</b> –∫–æ—Ä–æ–ª—é —Å—É–ø–µ—Ä–Ω–∏–∫–∞.</p>

        <h3>2. –®–∞—Ö, –ú–∞—Ç —ñ –ü–∞—Ç</h3>
        <ul>
            <li><b>–®–∞—Ö:</b> –ö–æ—Ä–æ–ª—å –ø—ñ–¥ –∞—Ç–∞–∫–æ—é. –í–∏ –∑–æ–±–æ–≤'—è–∑–∞–Ω—ñ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏ –π–æ–≥–æ (–≤—ñ–¥—ñ–π—Ç–∏, –∑–∞–∫—Ä–∏—Ç–∏—Å—è –∞–±–æ –∑–±–∏—Ç–∏ –Ω–∞–ø–∞–¥–∞—é—á—É —Ñ—ñ–≥—É—Ä—É).</li>
            <li><b>–ú–∞—Ç:</b> –ö–æ—Ä–æ–ª—å –ø—ñ–¥ –∞—Ç–∞–∫–æ—é —ñ –ø–æ—Ä—è—Ç—É–Ω–∫—É –Ω–µ–º–∞—î. –¶–µ –ø–µ—Ä–µ–º–æ–≥–∞!</li>
            <li><b>–ü–∞—Ç:</b> –£ –≥—Ä–∞–≤—Ü—è –Ω–µ–º–∞—î —Ö–æ–¥—ñ–≤, –∞–ª–µ –∫–æ—Ä–æ–ª—å –ù–ï –ø—ñ–¥ –∞—Ç–∞–∫–æ—é. –¶–µ –Ω—ñ—á–∏—è.</li>
        </ul>

        <h3>3. –§—ñ–≥—É—Ä–∏</h3>
        <ul>
            <li><b>–ü—ñ—à–∞–∫:</b> –í–ø–µ—Ä–µ–¥ –Ω–∞ 1 (–∞–±–æ –Ω–∞ 2 –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É —Ö–æ–¥—ñ). –ë'—î –ø–æ –¥—ñ–∞–≥–æ–Ω–∞–ª—ñ.</li>
            <li><b>–ö—ñ–Ω—å:</b> –ë—É–∫–≤–æ—é "–ì", –º–æ–∂–µ –ø–µ—Ä–µ—Å—Ç—Ä–∏–±—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ —Ñ—ñ–≥—É—Ä–∏.</li>
            <li><b>–¢—É—Ä–∞:</b> –ü—Ä—è–º–æ –ø–æ –ª—ñ–Ω—ñ—è—Ö.</li>
            <li><b>–°–ª–æ–Ω:</b> –¢—ñ–ª—å–∫–∏ –ø–æ –¥—ñ–∞–≥–æ–Ω–∞–ª—ñ.</li>
            <li><b>–§–µ—Ä–∑—å:</b> –£ –±—É–¥—å-—è–∫–æ–º—É –Ω–∞–ø—Ä—è–º–∫—É (–Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–∞).</li>
            <li><b>–ö–æ—Ä–æ–ª—å:</b> –ù–∞ 1 –∫–ª—ñ—Ç–∏–Ω–∫—É –Ω–∞–≤–∫–æ–ª–æ —Å–µ–±–µ.</li>
        </ul>

        <h3>4. –û—Å–æ–±–ª–∏–≤—ñ —Ö–æ–¥–∏</h3>
        <ul>
            <li><b>–†–æ–∫—ñ—Ä–æ–≤–∫–∞:</b> –ö–æ—Ä–æ–ª—å —ñ —Ç—É—Ä–∞ —Ä—É—Ö–∞—é—Ç—å—Å—è –Ω–∞–∑—É—Å—Ç—Ä—ñ—á –æ–¥–Ω–æ—á–∞—Å–Ω–æ (—è–∫—â–æ –≤–æ–Ω–∏ —â–µ –Ω–µ —Ö–æ–¥–∏–ª–∏ —ñ —à–ª—è—Ö –≤—ñ–ª—å–Ω–∏–π).</li>
            <li><b>–ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ—à–∞–∫–∞:</b> –î—ñ–π—à–æ–≤—à–∏ –¥–æ –∫—ñ–Ω—Ü—è –¥–æ—à–∫–∏, –ø—ñ—à–∞–∫ —Å—Ç–∞—î –§–µ—Ä–∑–µ–º.</li>
        </ul>
    </div>
</div>

<div id="game">
    <div id="status"></div>
    <div id="board"></div>
    <div id="room-display" style="margin-top:10px; color:#555"></div>
    <button class="btn btn-secondary" style="margin-top:20px; width: 100px" onclick="location.reload()">–ú–ï–ù–Æ</button>
</div>

<script>
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Firebase (—Ç–≤–æ—ó –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ)
    const firebaseConfig = {
        apiKey: "AIzaSyBTL6BV1GdauZ-6M5fK9USB-cq4Ut9cA0U",
        authDomain: "tictactoe-5bd62.firebaseapp.com",
        databaseURL: "https://tictactoe-5bd62-default-rtdb.firebaseio.com",
        projectId: "tictactoe-5bd62",
        storageBucket: "tictactoe-5bd62.firebasestorage.app",
        messagingSenderId: "934857521432",
        appId: "1:934857521432:web:cef29a6492be5cc578866d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = { id: '', board: [], turn: 'white', role: '', active: false, mode: '', gameOver: false };
    let selectedIdx = null;
    let legalMoves = [];
    const icons = {'P':'‚ôü','p':'‚ôü','R':'‚ôú','r':'‚ôú','N':'‚ôû','n':'‚ôû','B':'‚ôù','b':'‚ôù','Q':'‚ôõ','q':'‚ôõ','K':'‚ôö','k':'‚ôö'};

    function toggleGuide(show) { document.getElementById('guide').style.display = show ? 'flex' : 'none'; }

    async function start(mode) {
        state.mode = mode;
        const initial = ['r','n','b','q','k','b','n','r','p','p','p','p','p','p','p','p','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','.','P','P','P','P','P','P','P','P','R','N','B','Q','K','B','N','R'];
        if (mode === 'local' || mode === 'bot') {
            state.id = 'local'; state.role = 'white'; state.active = true; state.board = initial; render();
        } else if (mode === 'create') {
            const code = Math.floor(1000 + Math.random() * 9000);
            state.id = 'room_' + code; state.role = 'white';
            document.getElementById('room-display').innerText = "–ö–Ü–ú–ù–ê–¢–ê: " + code;
            await db.ref('chess/' + state.id).set({ board: initial, turn: 'white', active: false });
            listen();
        } else {
            const code = document.getElementById('roomCode').value;
            state.id = 'room_' + code; state.role = 'black';
            await db.ref('chess/' + state.id).update({ active: true });
            listen();
        }
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game').style.display = 'flex';
    }

    function listen() {
        db.ref('chess/' + state.id).on('value', snap => {
            const d = snap.val();
            if (d) { state.board = d.board; state.turn = d.turn; state.active = d.active; render(); }
        });
    }

    function render() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        if (state.role === 'black') boardEl.classList.add('flipped');
        
        const statusEl = document.getElementById('status');
        const inCheck = isKingInCheck(state.board, state.turn);
        const noMoves = getAllLegalMoves(state.board, state.turn).length === 0;

        if (noMoves) {
            state.gameOver = true;
            statusEl.innerHTML = inCheck ? "<span style='color:red'>–ú–ê–¢! –ü–ï–†–ï–ú–û–ì–ê " + (state.turn === 'white' ? "–ß–û–†–ù–ò–•" : "–ë–Ü–õ–ò–•") + "</span>" : "–ü–ê–¢! –ù–Ü–ß–ò–Ø";
        } else {
            statusEl.innerText = inCheck ? "‚ö†Ô∏è –®–ê–• " + (state.turn === 'white' ? "–ë–Ü–õ–ò–ú" : "–ß–û–†–ù–ò–ú") : "–•–Ü–î " + (state.turn === 'white' ? "–ë–Ü–õ–ò–•" : "–ß–û–†–ù–ò–•");
        }

        state.board.forEach((p, i) => {
            const cell = document.createElement('div');
            const r = Math.floor(i / 8), c = i % 8;
            cell.className = `cell ${(r + c) % 2 === 0 ? 'white-cell' : 'black-cell'}`;
            if (selectedIdx === i) cell.classList.add('selected');
            if (legalMoves.includes(i)) cell.classList.add(state.board[i] !== '.' ? 'capture' : 'target');
            if (p !== '.' && p.toLowerCase() === 'k' && isKingInCheck(state.board, p === p.toUpperCase() ? 'white' : 'black')) cell.classList.add('check');

            if (p !== '.') {
                const pEl = document.createElement('div');
                pEl.className = `piece ${p === p.toUpperCase() ? 'w' : 'b'}`;
                pEl.innerText = icons[p];
                cell.appendChild(pEl);
            }
            cell.onclick = () => handleCellClick(i);
            boardEl.appendChild(cell);
        });

        if (state.turn === 'black' && state.mode === 'bot' && !state.gameOver) setTimeout(botMove, 600);
    }

    // --- –õ–û–ì–Ü–ö–ê –¢–ê –ü–†–ê–í–ò–õ–ê ---
    function getPseudoMoves(board, idx) {
        const moves = []; const p = board[idx]; const type = p.toLowerCase();
        const isW = p === p.toUpperCase(); const r = Math.floor(idx / 8), c = idx % 8;
        if (type === 'p') {
            let d = isW ? -1 : 1;
            if (board[idx + d * 8] === '.') {
                moves.push(idx + d * 8);
                if ((isW && r === 6 && board[idx + d * 16] === '.') || (!isW && r === 1 && board[idx + d * 16] === '.')) moves.push(idx + d * 16);
            }
            [c - 1, c + 1].forEach(nc => {
                if (nc >= 0 && nc < 8) {
                    let ti = (r + d) * 8 + nc;
                    if (board[ti] && board[ti] !== '.' && isW !== (board[ti] === board[ti].toUpperCase())) moves.push(ti);
                }
            });
        } else {
            const ds = {'r':[[0,1],[0,-1],[1,0],[-1,0]],'b':[[1,1],[1,-1],[-1,1],[-1,-1]],'n':[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]],'q':[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]],'k':[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]};
            ds[type]?.forEach(d => {
                for (let s = 1; s < 8; s++) {
                    let nr = r + d[0]*s, nc = c + d[1]*s;
                    if (nr < 0 || nr > 7 || nc < 0 || nc > 7) break;
                    let ni = nr * 8 + nc;
                    if (board[ni] === '.') moves.push(ni);
                    else { if (isW !== (board[ni] === board[ni].toUpperCase())) moves.push(ni); break; }
                    if (type === 'n' || type === 'k') break;
                }
            });
        }
        return moves;
    }

    function isKingInCheck(board, color) {
        let kp = board.indexOf(color === 'white' ? 'K' : 'k');
        if (kp === -1) return false;
        for (let i = 0; i < 64; i++) {
            let p = board[i];
            if (p !== '.' && (color === 'white' ? p === p.toLowerCase() : p === p.toUpperCase())) {
                if (getPseudoMoves(board, i).includes(kp)) return true;
            }
        }
        return false;
    }

    function getLegalMoves(board, idx) {
        let color = board[idx] === board[idx].toUpperCase() ? 'white' : 'black';
        return getPseudoMoves(board, idx).filter(to => {
            let temp = [...board]; temp[to] = temp[idx]; temp[idx] = '.';
            return !isKingInCheck(temp, color);
        });
    }

    function getAllLegalMoves(board, color) {
        let all = [];
        board.forEach((p, i) => {
            if (p !== '.' && (color === 'white' ? p === p.toUpperCase() : p === p.toLowerCase())) {
                getLegalMoves(board, i).forEach(t => all.push({f: i, t: t}));
            }
        });
        return all;
    }

    function handleCellClick(i) {
        if (!state.active || state.gameOver) return;
        if (state.mode !== 'local' && state.turn !== state.role) return;
        const p = state.board[i];
        if (p !== '.' && (state.turn === 'white' ? p === p.toUpperCase() : p === p.toLowerCase())) {
            selectedIdx = i; legalMoves = getLegalMoves(state.board, i); render();
        } else if (selectedIdx !== null && legalMoves.includes(i)) {
            makeMove(selectedIdx, i);
        } else { selectedIdx = null; legalMoves = []; render(); }
    }

    function makeMove(f, t) {
        state.board[t] = state.board[f]; state.board[f] = '.';
        if (state.board[t] === 'P' && t < 8) state.board[t] = 'Q';
        if (state.board[t] === 'p' && t > 55) state.board[t] = 'q';
        state.turn = state.turn === 'white' ? 'black' : 'white';
        selectedIdx = null; legalMoves = [];
        if (state.id !== 'local') db.ref('chess/' + state.id).update({ board: state.board, turn: state.turn });
        else render();
    }

    function botMove() {
        let all = getAllLegalMoves(state.board, 'black');
        if (all.length) {
            all.sort((a,b) => (state.board[b.t] !== '.' ? 1 : 0) - (state.board[a.t] !== '.' ? 1 : 0));
            makeMove(all[0].f, all[0].t);
        }
    }
</script>
</body>
</html>
